<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civilization Sphere - Functional Tests</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0066CC;
            border-bottom: 3px solid #0066CC;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #0066CC;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-result.pass {
            background: #d1fae5;
            border-left: 4px solid #10b981;
        }
        .test-result.fail {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        .test-result.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .icon {
            font-size: 20px;
            font-weight: bold;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #0066CC, #00A8E8);
            color: white;
            border-radius: 8px;
            font-size: 18px;
        }
        #progress {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        #progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0066CC, #00A8E8);
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .test-app-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #0066CC, #00A8E8);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Civilization Sphere - Functional Test Suite</h1>
        
        <div id="progress">
            <div id="progress-bar">0%</div>
        </div>
        
        <div id="test-results"></div>
        
        <div id="summary" class="summary" style="display: none;"></div>
        
        <a href="/" class="test-app-link">‚Üí Open Main Application</a>
    </div>

    <script>
        const results = document.getElementById('test-results');
        const progressBar = document.getElementById('progress-bar');
        const summaryDiv = document.getElementById('summary');
        
        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;
        let warnings = 0;

        function addSection(title) {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `<h2>${title}</h2>`;
            results.appendChild(section);
            return section;
        }

        function addResult(section, status, message) {
            const result = document.createElement('div');
            result.className = `test-result ${status}`;
            
            let icon = '';
            if (status === 'pass') {
                icon = '‚úì';
                passedTests++;
            } else if (status === 'fail') {
                icon = '‚úó';
                failedTests++;
            } else if (status === 'warning') {
                icon = '‚ö†';
                warnings++;
            }
            
            result.innerHTML = `<span class="icon">${icon}</span><span>${message}</span>`;
            section.appendChild(result);
            totalTests++;
            updateProgress();
        }

        function updateProgress() {
            const progress = ((passedTests + failedTests + warnings) / totalTests * 100).toFixed(0);
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
        }

        function showSummary() {
            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = `
                <h3>Test Summary</h3>
                <p>‚úì Passed: ${passedTests} | ‚úó Failed: ${failedTests} | ‚ö† Warnings: ${warnings}</p>
                <p>Total Tests: ${totalTests}</p>
                ${failedTests === 0 ? '<p>üéâ ALL TESTS PASSED!</p>' : '<p>‚ö†Ô∏è Some tests failed. Review above.</p>'}
            `;
        }

        async function runTests() {
            // TEST 1: Application Load
            const section1 = addSection('1. Application Load & Initialization');
            
            try {
                const response = await fetch('/');
                if (response.ok) {
                    addResult(section1, 'pass', 'Application HTML loads successfully');
                } else {
                    addResult(section1, 'fail', `Application load failed: ${response.status}`);
                }
            } catch (error) {
                addResult(section1, 'fail', `Application load error: ${error.message}`);
            }

            // TEST 2: Data Loading
            const section2 = addSection('2. Data Loading & Validation');
            
            try {
                const response = await fetch('/data/events.json');
                if (response.ok) {
                    const events = await response.json();
                    addResult(section2, 'pass', `Events data loaded: ${events.length} events`);
                    
                    if (events.length > 0) {
                        addResult(section2, 'pass', 'Events array is not empty');
                        
                        // Check first event structure
                        const firstEvent = events[0];
                        if (firstEvent.id && firstEvent.title && firstEvent.date) {
                            addResult(section2, 'pass', 'Event structure validation passed');
                        } else {
                            addResult(section2, 'fail', 'Event structure missing required fields');
                        }
                        
                        // Check for coordinates
                        const eventsWithCoords = events.filter(e => e.lat && e.lng).length;
                        if (eventsWithCoords > 0) {
                            addResult(section2, 'pass', `${eventsWithCoords} events have coordinates`);
                        } else {
                            addResult(section2, 'warning', 'No events have coordinates (will use defaults)');
                        }
                        
                        // Check categories
                        const categories = [...new Set(events.map(e => e.category).filter(Boolean))];
                        addResult(section2, 'pass', `${categories.length} unique categories found`);
                        
                        // Check regions
                        const regions = [...new Set(events.map(e => e.region).filter(Boolean))];
                        addResult(section2, 'pass', `${regions.length} unique regions found`);
                    } else {
                        addResult(section2, 'fail', 'Events array is empty');
                    }
                } else {
                    addResult(section2, 'fail', `Events data load failed: ${response.status}`);
                }
            } catch (error) {
                addResult(section2, 'fail', `Events data error: ${error.message}`);
            }

            // TEST 3: Static Assets
            const section3 = addSection('3. Static Assets & Libraries');
            
            const assets = [
                { url: '/style.css', name: 'Main stylesheet' },
                { url: '/app.js', name: 'Application JavaScript' }
            ];
            
            for (const asset of assets) {
                try {
                    const response = await fetch(asset.url);
                    if (response.ok) {
                        const content = await response.text();
                        const size = (content.length / 1024).toFixed(2);
                        addResult(section3, 'pass', `${asset.name} loaded (${size} KB)`);
                    } else {
                        addResult(section3, 'fail', `${asset.name} load failed`);
                    }
                } catch (error) {
                    addResult(section3, 'fail', `${asset.name} error: ${error.message}`);
                }
            }
            
            // Check external libraries
            const libraries = [
                'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
                'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js',
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'
            ];
            
            for (const lib of libraries) {
                try {
                    const response = await fetch(lib, { method: 'HEAD' });
                    const libName = lib.split('/').find(part => part.includes('leaflet') || part.includes('chart'));
                    if (response.ok) {
                        addResult(section3, 'pass', `External library accessible: ${libName}`);
                    } else {
                        addResult(section3, 'warning', `External library check failed: ${libName}`);
                    }
                } catch (error) {
                    addResult(section3, 'warning', `External library unreachable (may still work)`);
                }
            }

            // TEST 4: DOM Elements
            const section4 = addSection('4. DOM Structure & Elements');
            
            try {
                const response = await fetch('/');
                const html = await response.text();
                
                const requiredElements = [
                    { id: 'map', name: 'Map container' },
                    { id: 'search-input', name: 'Search input' },
                    { id: 'theme-toggle', name: 'Theme toggle button' },
                    { id: 'filters-sidebar', name: 'Filters sidebar' },
                    { id: 'details-sidebar', name: 'Details sidebar' },
                    { id: 'category-chart', name: 'Category chart canvas' },
                    { id: 'region-chart', name: 'Region chart canvas' },
                    { id: 'time-chart', name: 'Time chart canvas' },
                    { id: 'importance-chart', name: 'Importance chart canvas' },
                    { id: 'export-csv', name: 'CSV export button' },
                    { id: 'export-json', name: 'JSON export button' },
                    { id: 'play-btn', name: 'Timeline play button' },
                    { id: 'timeline-track', name: 'Timeline track' }
                ];
                
                requiredElements.forEach(element => {
                    if (html.includes(`id="${element.id}"`)) {
                        addResult(section4, 'pass', `${element.name} found in DOM`);
                    } else {
                        addResult(section4, 'fail', `${element.name} missing from DOM`);
                    }
                });
            } catch (error) {
                addResult(section4, 'fail', `DOM check error: ${error.message}`);
            }

            // TEST 5: CSS Validation
            const section5 = addSection('5. CSS & Styling');
            
            try {
                const response = await fetch('/style.css');
                const css = await response.text();
                
                // Check for CSS variables
                const cssVars = css.match(/--[\w-]+:/g);
                if (cssVars && cssVars.length > 50) {
                    addResult(section5, 'pass', `CSS custom properties defined: ${cssVars.length}`);
                } else {
                    addResult(section5, 'warning', 'Few CSS custom properties found');
                }
                
                // Check for responsive design
                if (css.includes('@media')) {
                    addResult(section5, 'pass', 'Responsive design media queries present');
                } else {
                    addResult(section5, 'warning', 'No media queries found');
                }
                
                // Check for animations
                if (css.includes('@keyframes') || css.includes('animation:')) {
                    addResult(section5, 'pass', 'CSS animations defined');
                } else {
                    addResult(section5, 'warning', 'No CSS animations found');
                }
                
                // Check for dark theme support
                if (css.includes('dark-theme') || css.includes('[data-theme="dark"]')) {
                    addResult(section5, 'pass', 'Dark theme support detected');
                } else {
                    addResult(section5, 'warning', 'Dark theme support not detected');
                }
            } catch (error) {
                addResult(section5, 'fail', `CSS validation error: ${error.message}`);
            }

            // TEST 6: JavaScript Structure
            const section6 = addSection('6. JavaScript Application Structure');
            
            try {
                const response = await fetch('/app.js');
                const js = await response.text();
                
                // Check for main class
                if (js.includes('class CivilizationSphere')) {
                    addResult(section6, 'pass', 'Main CivilizationSphere class found');
                } else {
                    addResult(section6, 'fail', 'Main application class not found');
                }
                
                // Check for essential methods
                const methods = [
                    'loadData', 'initializeMap', 'applyFilters', 'updateMap',
                    'updateCharts', 'startPlayback', 'exportToCSV', 'exportToJSON'
                ];
                
                let foundMethods = 0;
                methods.forEach(method => {
                    if (js.includes(method)) foundMethods++;
                });
                
                if (foundMethods === methods.length) {
                    addResult(section6, 'pass', `All ${methods.length} essential methods implemented`);
                } else {
                    addResult(section6, 'warning', `${foundMethods}/${methods.length} essential methods found`);
                }
                
                // Check for error handling
                const tryCatchCount = (js.match(/try\s*{/g) || []).length;
                if (tryCatchCount > 2) {
                    addResult(section6, 'pass', `Error handling: ${tryCatchCount} try-catch blocks`);
                } else {
                    addResult(section6, 'warning', 'Limited error handling detected');
                }
            } catch (error) {
                addResult(section6, 'fail', `JavaScript validation error: ${error.message}`);
            }

            // Show final summary
            showSummary();
        }

        // Run all tests
        runTests();
    </script>
</body>
</html>
